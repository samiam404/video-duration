<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improved Video Metadata Extractor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #dropZone {
            border: 2px dashed #ccc;
            border-radius: 20px;
            width: 100%;
            margin: 20px 0;
            padding: 20px;
            text-align: center;
        }
        #dropZone.highlight {
            background-color: #f0f0f0;
        }
        #fileList {
            margin-top: 20px;
        }
        progress {
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Improved Video Metadata Extractor</h1>
    <div id="dropZone">
        <p>Drag and drop video files or folders here</p>
        <p>Or</p>
        <input type="file" id="fileInput" multiple webkitdirectory directory>
    </div>
    <progress id="progress" value="0" max="100"></progress>
    <div id="fileList"></div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const progress = document.getElementById('progress');

        let totalDuration = 0;
        let processedFiles = 0;
        let totalFiles = 0;

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('highlight');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('highlight');
        });

        dropZone.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        async function handleDrop(e) {
            e.preventDefault();
            dropZone.classList.remove('highlight');
            const items = e.dataTransfer.items;
            await processItems(items);
        }

        async function handleFileSelect(e) {
            const files = e.target.files;
            await processFiles(files);
        }

        async function processItems(items) {
            totalDuration = 0;
            processedFiles = 0;
            totalFiles = 0;
            fileList.innerHTML = '';

            for (let item of items) {
                if (item.kind === 'file') {
                    const entry = item.webkitGetAsEntry();
                    if (entry) {
                        await traverseFileTree(entry);
                    }
                }
            }
        }

        async function traverseFileTree(item) {
            if (item.isFile) {
                const file = await new Promise(resolve => item.file(resolve));
                if (file.type.startsWith('video/')) {
                    totalFiles++;
                    await processVideoFile(file);
                }
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                await new Promise(resolve => {
                    dirReader.readEntries(async (entries) => {
                        for (let entry of entries) {
                            await traverseFileTree(entry);
                        }
                        resolve();
                    });
                });
            }
        }

        async function processFiles(files) {
            totalDuration = 0;
            processedFiles = 0;
            totalFiles = files.length;
            fileList.innerHTML = '';

            for (let file of files) {
                if (file.type.startsWith('video/')) {
                    await processVideoFile(file);
                } else {
                    totalFiles--;
                }
            }
        }

        async function processVideoFile(file) {
            try {
                const duration = await getVideoDuration(file);
                totalDuration += duration;
                displayFileInfo(file, duration);
            } catch (error) {
                console.error(`Error processing ${file.name}:`, error);
            }
            processedFiles++;
            updateProgress();
        }

        function getVideoDuration(file) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = () => {
                    URL.revokeObjectURL(video.src);
                    resolve(video.duration);
                };
                video.onerror = () => reject(new Error("Invalid video file"));
                video.src = URL.createObjectURL(file);
            });
        }

        function displayFileInfo(file, duration) {
            const fileInfo = document.createElement('p');
            fileInfo.textContent = `${file.name} - Duration: ${formatDuration(duration)}`;
            fileList.appendChild(fileInfo);
        }

        function displayTotalDuration() {
            const totalInfo = document.createElement('h3');
            totalInfo.textContent = `Total Duration: ${formatDuration(totalDuration)}`;
            fileList.appendChild(totalInfo);
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours}h ${minutes}m ${secs}s`;
        }

        function updateProgress() {
            const percentage = (processedFiles / totalFiles) * 100;
            progress.value = percentage;
            if (processedFiles === totalFiles) {
                displayTotalDuration();
            }
        }
    </script>
</body>
</html>